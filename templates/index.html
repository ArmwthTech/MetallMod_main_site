{% extends 'base.html' %}
{% block content %}
<section class="hero bg-white h-screen mb-16 shadow-none rounded-b-3xl flex flex-col items-center justify-center text-center relative overflow-hidden">
    <img src="/static/uploads/portfolio_img/kmd_3d_model.png" alt="3D модель КМД" class="absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none select-none z-0">
    <h1 class="text-4xl md:text-5xl lg:text-7xl font-extrabold mb-8 text-[#123392] leading-tight z-10">{{ _('Надёжные чертежи КМД,') }}<br>{{ _('с которыми стройка не встанет') }}</h1>
    <div class="z-10 px-4 md:px-8">
      <p class="text-2xl md:text-3xl text-gray-700 mb-6 text-left">{{ _('Разрабатываем точные чертежи металлоконструкций любой сложности для строительных компаний и инженерных проектов') }}</p>
      <div class="flex flex-col md:flex-row gap-6 z-10 mb-10">
        <div class="flex-1 bg-black/60 rounded-2xl p-4 md:p-8 flex items-center gap-4 shadow-xl">
          <span class="inline-block w-3 h-3 bg-[#ff590d] rounded-sm"></span>
          <span class="text-xl md:text-2xl font-extrabold text-white">ОТ 700 Р/ТОННА</span>
        </div>
        <div class="flex-1 bg-black/60 rounded-2xl p-4 md:p-8 flex items-center gap-4 shadow-xl">
          <span class="inline-block w-3 h-3 bg-[#ff590d] rounded-sm"></span>
          <span class="text-xl md:text-2xl font-extrabold text-white">ОТ 5 РАБОЧИХ ДНЕЙ</span>
        </div>
        <div class="flex-1 bg-black/60 rounded-2xl p-4 md:p-8 flex items-center gap-4 shadow-xl">
          <span class="inline-block w-3 h-3 bg-[#ff590d] rounded-sm"></span>
          <span class="text-xl md:text-2xl font-extrabold text-white">РАСЧЕТ ЗА 1 ДЕНЬ</span>
        </div>
      </div>
    </div>
    <div class="flex flex-col sm:flex-row gap-6 justify-center mb-4 z-10">
        <button id="open-km-modal" class="bg-[#ff590d] hover:bg-orange-600 transition px-6 md:px-12 py-4 md:py-5 rounded-2xl text-xl md:text-2xl font-bold shadow-xl focus:outline-none focus:ring-4 focus:ring-[#ff590d]/30 text-white whitespace-nowrap">Отправить КМ на расчет</button>
        <a href="https://t.me/metallmod_bot" target="_blank" class="bg-[#123392] hover:bg-blue-900 transition px-6 md:px-12 py-4 md:py-5 rounded-2xl text-xl md:text-2xl font-bold text-white flex items-center gap-3 shadow-xl border border-[#123392] focus:outline-none focus:ring-4 focus:ring-[#123392]/20 whitespace-nowrap"><i class="fab fa-telegram-plane text-2xl md:text-3xl"></i>{{ _('Написать в Telegram') }}</a>
    </div>
</section>

<section class="advantages mb-20">
  <h2 class="text-4xl font-extrabold mb-12 text-center text-[#123392]">Почему нас выбирают?</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 px-4 max-w-7xl mx-auto">
    <!-- Карточка 1 -->
    <div class="bg-white rounded-3xl shadow-xl min-h-[260px] grid grid-rows-[80px_64px_48px] px-8 py-10 border-t-4 border-[#ff590d]">
      <div class="flex items-center justify-center">
        <i class="fa fa-check-circle text-5xl text-[#123392]"></i>
      </div>
      <div class="flex items-center justify-center h-16">
        <span class="text-3xl font-bold text-[#123392] text-center">100+</span>
      </div>
      <div class="flex items-start justify-center">
        <span class="text-lg text-gray-500 text-center">Более 100 реализованных проектов</span>
      </div>
    </div>
    <!-- Карточка 2 -->
    <div class="bg-white rounded-3xl shadow-xl min-h-[260px] grid grid-rows-[80px_64px_48px] px-8 py-10 border-t-4 border-[#ff590d]">
      <div class="flex items-center justify-center">
        <i class="fa fa-clock text-5xl text-[#123392]"></i>
      </div>
      <div class="flex items-center justify-center h-16">
        <span class="text-3xl font-bold text-[#123392] text-center">от 5 дней</span>
      </div>
      <div class="flex items-start justify-center">
        <span class="text-lg text-gray-500 text-center">на разработку</span>
      </div>
    </div>
    <!-- Карточка 3 -->
    <div class="bg-white rounded-3xl shadow-xl min-h-[260px] grid grid-rows-[80px_64px_48px] px-8 py-10 border-t-4 border-[#ff590d]">
      <div class="flex items-center justify-center">
        <i class="fa fa-shield-alt text-5xl text-[#123392]"></i>
      </div>
      <div class="flex items-center justify-center h-16">
        <span class="text-xl font-bold text-[#123392] text-center leading-tight">Гарантия качества<br>и соблюдение сроков</span>
      </div>
      <div class="flex items-start justify-center">
        <span class="text-base text-gray-500 text-center">указанных в договоре</span>
      </div>
    </div>
    <!-- Карточка 4 -->
    <div class="bg-white rounded-3xl shadow-xl min-h-[260px] grid grid-rows-[80px_64px_48px] px-8 py-10 border-t-4 border-[#ff590d]">
      <div class="flex items-center justify-center">
        <i class="fa fa-users text-5xl text-[#123392]"></i>
      </div>
      <div class="flex items-center justify-center h-16">
        <span class="text-3xl font-bold text-[#123392] text-center">&gt; 90% клиентов</span>
      </div>
      <div class="flex items-start justify-center">
        <span class="text-lg text-gray-500 text-center">обращаются повторно</span>
      </div>
    </div>
  </div>
</section>

<section id="services" class="mb-20 px-4 md:px-8">
    <h2 class="text-4xl font-extrabold mb-12 text-center text-[#123392]">{{ _('Наши услуги') }}</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 justify-center">
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#123392] text-center">
            <i class="fa fa-drafting-compass text-4xl text-[#ff590d] mb-4"></i>
            <div class="text-2xl font-bold mb-2">{{ _('Разработка КМД') }}</div>
            <div class="text-gray-600 text-lg">{{ _('Полный комплект чертежей конструкций металлических деталей по вашим проектам и спецификациям') }}</div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#123392] text-center">
            <i class="fa fa-tools text-4xl text-[#ff590d] mb-4"></i>
            <div class="text-2xl font-bold mb-2">{{ _('Адаптация проектов') }}</div>
            <div class="text-gray-600 text-lg">{{ _('Доработка и адаптация существующих проектов под новые требования и стандарты') }}</div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#123392] text-center">
            <i class="fa fa-cubes text-4xl text-[#ff590d] mb-4"></i>
            <div class="text-2xl font-bold mb-2">{{ _('BIM-моделирование') }}</div>
            <div class="text-gray-600 text-lg">{{ _('Создание информационных 3D-моделей металлоконструкций с полной детализацией') }}</div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#123392] text-center">
            <i class="fa fa-clipboard-check text-4xl text-[#ff590d] mb-4"></i>
            <div class="text-2xl font-bold mb-2">{{ _('Проверка по ГОСТ') }}</div>
            <div class="text-gray-600 text-lg">{{ _('Экспертиза и корректировка проектов на соответствие актуальным нормативам и стандартам') }}</div>
        </div>
    </div>
</section>

<!-- Блок с текстами -->
<section class="mb-10">
    <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-3xl md:text-4xl font-extrabold mb-4 text-[#123392]">Подготовим расчет стоимости и сроков за 1 рабочий день</h2>
        <div class="text-xl md:text-2xl text-gray-700 mb-2">Позвоните для консультации</div>
        <div class="text-lg text-gray-500 mb-2">*Работаем по будням с 9 до 18*</div>
        <div class="text-xl font-bold text-[#ff590d] mb-2">Оставьте заявку, и менеджер свяжется с вами в течение 30 минут</div>
        <div class="text-2xl font-extrabold text-[#123392]">+7 4922 22-19-12</div>
    </div>
</section>

<section class="flex flex-col lg:flex-row gap-10 justify-center items-start mb-20">
    <div class="mini-calc max-w-md w-full bg-white rounded-3xl shadow-2xl p-10 border-t-4 border-[#123392] mb-10 lg:mb-0">
        <h2 class="text-2xl font-bold mb-8 text-center flex items-center gap-3 text-[#123392]"><i class="fa fa-balance-scale"></i> {{ _('Мини-калькулятор') }}</h2>
        <form id="miniCalcForm" class="flex flex-col gap-6" action="#">
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-weight-hanging"></i>
                <input type="number" name="tons" min="1" step="1" placeholder="{{ _('Тоннаж, т') }}" required class="bg-transparent outline-none flex-1 text-base md:text-lg">
            </div>
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-layer-group"></i>
                <select name="difficulty" required class="bg-transparent outline-none flex-1 text-base md:text-lg">
                    <option value="1.8">{{ _('Обычная сложность') }}</option>
                    <option value="2">{{ _('Средняя сложность') }}</option>
                    <option value="2.3">{{ _('Высокая сложность') }}</option>
                </select>
            </div>
            <button type="submit" class="bg-[#ff590d] hover:bg-orange-600 transition px-10 py-4 rounded-2xl text-xl font-bold text-white shadow-lg flex items-center gap-2 justify-center focus:outline-none focus:ring-4 focus:ring-[#ff590d]/30"><i class="fa fa-equals"></i> {{ _('Рассчитать') }}</button>
        </form>
        <div id="miniCalcResult" class="mt-6 text-center">
            <!-- Здесь будет результат -->
        </div>
    </div>
    <div class="calc-form max-w-md w-full bg-white rounded-3xl shadow-2xl p-10 border-t-4 border-[#ff590d]">
        <h2 class="text-2xl font-bold mb-8 text-center flex items-center gap-3 text-[#123392]"><i class="fa fa-clipboard-list text-[#ff590d]"></i> {{ _('Оставить заявку') }}</h2>
        <form id="calcForm" method="post" enctype="multipart/form-data" action="/send-calc-form" class="flex flex-col gap-6">
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-user"></i>
                <input type="text" name="name" placeholder="{{ _('Имя') }}" required minlength="2" maxlength="50" pattern="^[А-Яа-яA-Za-z\-\s]+$" class="bg-transparent outline-none flex-1 text-base md:text-lg">
            </div>
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-phone"></i>
                <input type="tel" name="phone" id="calcFormPhone" placeholder="+7 (999) 999-99-99" required pattern="^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$" maxlength="18" class="bg-transparent outline-none flex-1 text-base md:text-lg">
            </div>
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-envelope"></i>
                <input type="email" name="email" placeholder="{{ _('Почта') }}" required maxlength="100" class="bg-transparent outline-none flex-1 text-base md:text-lg">
            </div>
            <div class="flex items-center gap-3 bg-gray-100 rounded-xl px-4 py-4">
                <i class="fa fa-link"></i>
                <input type="url" name="km_link" placeholder="Укажите ссылку на разработанный КМ (Google Drive, Яндекс.Диск, Dropbox и т.д.)" maxlength="200" class="block w-full max-w-none bg-gray-100 rounded-xl px-4 py-4 outline-none text-base md:text-lg">
            </div>
            <div class="flex items-center gap-3">
                <input type="checkbox" name="consent" required class="accent-[#ff590d] w-5 h-5">
                <label class="text-sm text-gray-700">Даю <a href="/consent" target="_blank" class="underline text-[#ff590d]">Согласие на обработку персональных данных</a> и принимаю <a href="/policy" target="_blank" class="underline text-[#ff590d]">Политику в отношении обработки персональных данных</a></label>
            </div>
            <button type="submit" class="bg-[#ff590d] hover:bg-orange-600 transition px-10 py-4 rounded-2xl text-xl font-bold text-white shadow-lg flex items-center gap-2 justify-center focus:outline-none focus:ring-4 focus:ring-[#ff590d]/30"><i class="fa fa-paper-plane"></i> {{ _('Оставить заявку') }}</button>
        </form>
    </div>
</section>

<!-- В состав чертежей входит -->
<section class="mb-20">
    <h2 class="text-4xl font-extrabold mb-10 text-center text-[#123392]">В состав чертежей входит</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-5xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <i class="fa fa-file-alt text-4xl text-[#123392] mb-4"></i>
            <div class="text-xl font-bold mb-2">Общие данные</div>
            <div class="text-gray-600 text-center">Пояснительная записка, спецификации, ведомости</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <i class="fa fa-project-diagram text-4xl text-[#123392] mb-4"></i>
            <div class="text-xl font-bold mb-2">Сборочные чертежи</div>
            <div class="text-gray-600 text-center">Общий вид, схемы расположения элементов, монтажные схемы</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <i class="fa fa-cogs text-4xl text-[#123392] mb-4"></i>
            <div class="text-xl font-bold mb-2">Деталировка</div>
            <div class="text-gray-600 text-center">Чертежи деталей, спецификации металла, ведомости расхода</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <i class="fa fa-list-alt text-4xl text-[#123392] mb-4"></i>
            <div class="text-xl font-bold mb-2">Ведомости и спецификации</div>
            <div class="text-gray-600 text-center">Ведомости деталей, метизов, спецификации изделий и материалов</div>
        </div>
    </div>
</section>

<!-- СТОИМОСТЬ -->
<section class="mb-20">
    <h2 class="text-4xl font-extrabold mb-10 text-center text-[#123392]">Стоимость</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-[#ff590d]/10 mb-4 shadow"><i class="fa fa-balance-scale text-3xl text-[#ff590d]"></i></div>
            <div class="text-3xl font-extrabold text-[#123392] mb-2">от 600 р/тонна</div>
            <div class="text-gray-600 text-center">Проекты 10–200 тонн</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-[#123392]/10 mb-4 shadow"><i class="fa fa-stairs text-3xl text-[#123392]"></i></div>
            <div class="text-3xl font-extrabold text-[#123392] mb-2">от 650 р/тонна</div>
            <div class="text-gray-600 text-center">Легкие конструкции (лестницы, площадки)</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-[#ff590d]/10 mb-4 shadow"><i class="fa fa-cogs text-3xl text-[#ff590d]"></i></div>
            <div class="text-3xl font-extrabold text-[#123392] mb-2">от 700 р/тонна</div>
            <div class="text-gray-600 text-center">Сложные/нестандартные конструкции</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-8 flex flex-col items-center border-t-4 border-[#ff590d]">
            <div class="w-16 h-16 flex items-center justify-center rounded-full bg-[#123392]/10 mb-4 shadow"><i class="fa fa-warehouse text-3xl text-[#123392]"></i></div>
            <div class="text-3xl font-extrabold text-[#123392] mb-2">от 250 р/тонна</div>
            <div class="text-gray-600 text-center">Простые сооружения &gt;200 тонн</div>
        </div>
    </div>
</section>

<!-- Форма выдачи КМД -->
<section class="mb-20">
    <h2 class="text-4xl font-extrabold mb-10 text-center text-[#123392]">Форма выдачи КМД</h2>
    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl p-8 border-t-4 border-[#ff590d]">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8 justify-center items-stretch">
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-[#123392]/10 mb-2 shadow-lg"><i class="fa fa-file-pdf text-5xl text-[#ff590d]"></i></div>
                <div class="text-xl font-bold">PDF</div>
                <div class="text-gray-600 text-base">Для просмотра и печати</div>
            </div>
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-[#123392]/10 mb-2 shadow-lg"><i class="fa fa-file-archive text-5xl text-[#123392]"></i></div>
                <div class="text-xl font-bold">DWG</div>
                <div class="text-gray-600 text-base">Для производства (AutoCAD)</div>
            </div>
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-[#ff590d]/10 mb-2 shadow-lg"><i class="fa fa-file-archive text-5xl text-[#ff590d]"></i></div>
                <div class="text-xl font-bold">DXF</div>
                <div class="text-gray-600 text-base">Для станков и ЧПУ</div>
            </div>
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-[#123392]/10 mb-2 shadow-lg"><i class="fa fa-file-image text-5xl text-[#123392]"></i></div>
                <div class="text-xl font-bold">JPG/PNG</div>
                <div class="text-gray-600 text-base">Для быстрой отправки и просмотра</div>
            </div>
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-24 h-24 flex items-center justify-center rounded-full bg-[#ff590d]/10 mb-2 shadow-lg"><i class="fa fa-file-excel text-5xl text-[#ff590d]"></i></div>
                <div class="text-xl font-bold">Excel</div>
                <div class="text-gray-600 text-base">Спецификации и ведомости</div>
            </div>
        </div>
    </div>
</section>

<!-- НАШИ ВЫПОЛНЕННЫЕ ПРОЕКТЫ -->
<section id="portfolio" class="mb-24">
    <h2 class="text-4xl font-extrabold mb-12 text-center text-[#123392]">НАШИ ВЫПОЛНЕННЫЕ ПРОЕКТЫ</h2>
    <div class="relative">
        <!-- Swiper контейнер -->
        <div class="swiper portfolio-swiper">
            <div class="swiper-wrapper">
                {% for item in portfolio_items %}
                <div class="swiper-slide overflow-visible group">
                  <div class="portfolio-item bg-white rounded-3xl shadow-2xl p-4 flex flex-col items-center border-t-4 border-[#ff590d] transition-transform duration-300 group-hover:scale-110 group-hover:shadow-3xl cursor-pointer" data-title="{{ item.title }}" data-description="{{ item.description }}" data-images="{{ item.image_paths|default('[]') }}">
                      {% set images = item.image_paths|from_json if item.image_paths else [] %}
                      {% if images %}
                      <img src="{{ images[0] }}" alt="{{ item.title }}" class="rounded-xl w-full h-48 object-cover mb-4 shadow-md">
                      {% elif item.image_path %}
                      <img src="{{ item.image_path }}" alt="{{ item.title }}" class="rounded-xl w-full h-48 object-cover mb-4 shadow-md">
                      {% endif %}
                      <div class="portfolio-desc text-xl font-bold text-[#123392] text-center">{{ item.title }}</div>
                  </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
<!-- Swiper.js CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  new Swiper('.portfolio-swiper', {
    slidesPerView: 1,
    spaceBetween: 24,
    breakpoints: {
      768: { slidesPerView: 2 },
      1024: { slidesPerView: 3 }
    },
    loop: true,
    autoplay: { delay: 6000, disableOnInteraction: false },
    grabCursor: true,
    simulateTouch: true,
    allowTouchMove: true,
    // Без стрелок и точек
    navigation: false,
    pagination: false
  });

  // Portfolio modal logic
  const modal = document.getElementById('portfolio-modal');
  const closeBtn = document.getElementById('portfolio-modal-close');
  const imgEl = document.getElementById('portfolio-modal-image');
  const titleEl = document.getElementById('portfolio-modal-title');
  const descEl = document.getElementById('portfolio-modal-description');
  const prevBtn = document.getElementById('portfolio-modal-prev');
  const nextBtn = document.getElementById('portfolio-modal-next');
  const dotsEl = document.getElementById('portfolio-modal-dots');
  let images = [], current = 0;
  function show(idx) {
    if (!images.length) return;
    imgEl.src = images[idx];
    dotsEl.innerHTML = '';
    images.forEach((_, i) => {
      const dot = document.createElement('button');
      dot.className = 'w-3 h-3 rounded-full ' + (i === idx ? 'bg-[#ff590d]' : 'bg-gray-300') + ' mx-1';
      dot.onclick = () => { current = i; show(current); };
      dotsEl.appendChild(dot);
    });
  }
  function openModal() {
    modal.classList.remove('hidden');
    modal.classList.remove('portfolio-modal-animate-in');
    void modal.offsetWidth; // reflow
    modal.classList.add('portfolio-modal-animate-in');
  }
  function closeModal() {
    modal.classList.remove('portfolio-modal-animate-in');
    modal.classList.add('animate-fade-out');
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('animate-fade-out');
    }, 300);
  }
  document.querySelectorAll('.portfolio-item').forEach(item => {
    item.addEventListener('click', function() {
      titleEl.textContent = item.dataset.title;
      descEl.textContent = item.dataset.description;
      try {
        images = JSON.parse(item.dataset.images);
      } catch { images = []; }
      if (!images.length && item.querySelector('img')) images = [item.querySelector('img').src];
      current = 0;
      show(current);
      openModal();
    });
  });
  closeBtn.addEventListener('click', closeModal);
  modal.onclick = e => { if (e.target === modal) closeModal(); };
  document.addEventListener('keydown', e => { if (!modal.classList.contains('hidden') && e.key === 'Escape') closeModal(); });
});
</script>

<!-- Модальное окно портфолио -->
<div id="portfolio-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
    <div class="relative bg-white rounded-3xl shadow-2xl w-[95%] max-w-6xl mx-4 flex flex-col md:flex-row overflow-hidden animate-fade-in">
        <button id="portfolio-modal-close" class="absolute top-6 right-6 text-4xl text-gray-400 hover:text-[#ff590d] transition-colors focus:outline-none z-10">&times;</button>
        <div class="flex-1 p-10 flex flex-col justify-center min-w-[300px]">
            <div id="portfolio-modal-title" class="text-3xl font-extrabold mb-6 text-[#123392]"></div>
            <div id="portfolio-modal-description" class="text-gray-700 text-xl leading-relaxed"></div>
        </div>
        <div class="flex-1 bg-gray-50 flex flex-col items-center justify-center p-10 min-w-[400px]">
            <div class="relative w-full">
                <img id="portfolio-modal-image" src="" alt="" class="rounded-xl w-full h-[500px] object-contain shadow-md bg-white">
                <button id="portfolio-modal-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-[#ff590d] text-[#123392] hover:text-white rounded-full w-12 h-12 flex items-center justify-center shadow transition"><i class="fa fa-chevron-left text-xl"></i></button>
                <button id="portfolio-modal-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-[#ff590d] text-[#123392] hover:text-white rounded-full w-12 h-12 flex items-center justify-center shadow transition"><i class="fa fa-chevron-right text-xl"></i></button>
            </div>
            <div id="portfolio-modal-dots" class="flex justify-center gap-2 mt-6"></div>
        </div>
    </div>
</div>

<section id="steps" class="mb-24">
    <h2 class="text-3xl md:text-4xl font-extrabold mb-12 text-center text-[#123392]">{{ _('Как мы работаем') }}</h2>
    <div class="flex flex-wrap justify-center gap-10">
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center min-w-[200px] border-t-4 border-[#123392]">
            <span class="text-4xl font-extrabold text-[#ff590d] mb-2">1</span>
            <span class="text-xl font-bold mb-2">{{ _('Заявка') }}</span>
            <span class="text-gray-600 text-center">{{ _('Оставьте заявку через сайт или Telegram-бот с описанием проекта') }}</span>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center min-w-[200px] border-t-4 border-[#123392]">
            <span class="text-4xl font-extrabold text-[#ff590d] mb-2">2</span>
            <span class="text-xl font-bold mb-2">{{ _('Обсуждение') }}</span>
            <span class="text-gray-600 text-center">{{ _('Согласовываем технические детали и требования к проекту') }}</span>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center min-w-[200px] border-t-4 border-[#123392]">
            <span class="text-4xl font-extrabold text-[#ff590d] mb-2">3</span>
            <span class="text-xl font-bold mb-2">{{ _('Оплата') }}</span>
            <span class="text-gray-600 text-center">{{ _('Заключаем договор и вносите предоплату 50% от стоимости') }}</span>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center min-w-[200px] border-t-4 border-[#123392]">
            <span class="text-4xl font-extrabold text-[#ff590d] mb-2">4</span>
            <span class="text-xl font-bold mb-2">{{ _('Разработка') }}</span>
            <span class="text-gray-600 text-center">{{ _('Выполняем проектирование согласно техническому заданию') }}</span>
        </div>
        <div class="bg-white rounded-3xl shadow-xl p-8 flex flex-col items-center min-w-[200px] border-t-4 border-[#123392]">
            <span class="text-4xl font-extrabold text-[#ff590d] mb-2">5</span>
            <span class="text-xl font-bold mb-2">{{ _('Сдача проекта') }}</span>
            <span class="text-gray-600 text-center">{{ _('Передаем готовые чертежи и документацию после финальной оплаты') }}</span>
        </div>
    </div>
</section>

<section id="reviews" class="mb-24">
    <h2 class="text-4xl font-extrabold mb-12 text-center text-[#123392]">{{ _('Отзывы наших клиентов') }}</h2>
    <div class="relative">
        <div id="reviews-slider-wrapper" class="relative">
            <div id="reviews-slider" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 justify-center opacity-100 transition-opacity duration-500">
                {% for review in reviews %}
                <div class="review-item bg-white rounded-2xl shadow-xl p-5 flex flex-col items-center border-t-4 border-[#ff590d] hover:scale-105 transition-transform w-96 max-w-md h-64 min-h-64 max-h-64 mx-auto">
                    {% if review.logo_path %}
                    <img src="{{ review.logo_path }}" alt="logo" class="review-logo rounded-full w-12 h-12 object-contain mb-3 border-2 border-[#123392] shadow-md">
                    {% endif %}
                    <div class="review-text text-base italic mb-2 text-[#123392] text-center">{{ review.text }}</div>
                    <div class="text-gray-500 flex items-center gap-2 text-sm mt-auto"><i class="fa fa-user-tie"></i> {{ review.client_name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div id="reviews-dots" class="flex justify-center gap-2 mt-4"></div>
    </div>
</section>

<section id="contacts" class="mb-24">
    <h2 class="text-4xl font-extrabold mb-12 text-center text-[#123392]">{{ _('Контакты') }}</h2>
    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-xl p-10 text-lg border-t-4 border-[#123392] flex flex-col items-start mb-8">
        <div class="flex flex-col md:flex-row md:items-start md:gap-12 w-full">
            <div class="md:order-2 md:w-1/2 w-full mb-6 md:mb-0">
                <div class="flex items-center gap-3 mb-4 text-2xl font-bold text-[#123392]"><i class="fa fa-map-marker-alt text-[#ff590d]"></i> Свердловская область,<br>г. Екатеринбург, Первомайская 56</div>
                <div class="flex items-center gap-3 mb-2"><i class="fa fa-phone text-[#ff590d]"></i> <a href="tel:+79995274210" class="hover:text-[#ff590d] font-semibold">+7 (999) 527-42-10</a></div>
                <div class="flex items-center gap-3 mb-2"><i class="fa fa-envelope text-[#ff590d]"></i> <a href="mailto:info@metallmod.ru" class="hover:text-[#ff590d] font-semibold">info@metallmod.ru</a></div>
                <div class="flex items-center gap-3 mb-2"><i class="fa fa-clock text-[#ff590d]"></i> <span class="font-semibold">Пн-Пт: 9:00 — 18:00</span></div>
                <div class="text-gray-400 text-sm mt-2">Поддержка: 24/7</div>
                <div class="flex flex-col gap-4 w-full md:w-auto mt-6">
                    <a href="#calcForm" class="bg-[#ff590d] hover:bg-orange-600 transition px-8 py-4 rounded-2xl text-xl font-bold text-white shadow-lg flex items-center gap-2 justify-center"><i class="fa fa-paper-plane"></i> Оставить заявку</a>
                </div>
            </div>
            <div class="md:order-1 md:w-1/2 w-full">
                <div class="w-full flex justify-center items-center">
                    <div id="yandex-map" class="rounded-3xl shadow-md w-full h-[320px] md:h-[480px]"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="popup-overlay" style="display:none;" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
    <div class="relative bg-white rounded-3xl shadow-2xl p-10 max-w-sm w-full mx-4 text-center border-t-4 border-[#ff590d] animate-fade-in">
        <button id="popup-close" class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-[#ff590d] transition-colors focus:outline-none">&times;</button>
        <h3 class="text-2xl font-extrabold mb-6 text-[#123392] flex items-center gap-3 justify-center"><i class="fa fa-gift text-[#ff590d] text-3xl"></i> {{ _('Напиши нам о своем проекте и получи 10% скидку на первый заказ!') }}</h3>
        <form id="popupForm" action="#" class="flex flex-col gap-6">
            <input type="email" name="email" placeholder="Email" required class="bg-gray-100 rounded-xl px-5 py-4 outline-none text-base md:text-lg">
            <button type="submit" class="bg-[#ff590d] hover:bg-orange-600 transition px-8 py-4 rounded-2xl text-xl font-bold text-white shadow-lg flex items-center gap-2 justify-center focus:outline-none focus:ring-4 focus:ring-[#ff590d]/30"><i class="fa fa-percent"></i> {{ _('Получить скидку') }}</button>
        </form>
    </div>
</div>

<!-- Модальное окно для отправки КМ на расчет -->
<div id="km-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden">
  <div class="relative bg-white rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-10 flex flex-col animate-fade-in">
    <button id="close-km-modal" class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-[#ff590d] transition-colors focus:outline-none">&times;</button>
    <div class="mb-6 text-center">
      <div class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">
        ОТПРАВЬТЕ КМ ИЛИ ИНУЮ<br>
        <span class="text-[#ff590d]">ТЕХНИЧЕСКУЮ ИНФОРМАЦИЮ</span><br>
        ПО ПРОЕКТУ
      </div>
      <div class="text-base md:text-lg text-gray-700 mt-2">
        получите расчет вашего проекта<br>в течение <span class="font-bold text-[#ff590d]">24 часов</span>
      </div>
    </div>
    <form id="kmForm" method="post" action="/send-km-form" class="flex flex-col gap-6">
      <input type="text" name="name" placeholder="Имя" class="border-b border-gray-300 py-2 px-0 focus:outline-none focus:border-[#ff590d] text-base md:text-lg" />
      <input type="tel" name="phone" placeholder="+7 (999) 999-99-99" class="border-b border-gray-300 py-2 px-0 focus:outline-none focus:border-[#ff590d] text-base md:text-lg" />
      <input type="email" name="email" placeholder="Почта" class="border-b border-gray-300 py-2 px-0 focus:outline-none focus:border-[#ff590d] text-base md:text-lg" />
      <input type="url" name="km_link" placeholder="Укажите ссылку на разработанный КМ (Google Drive, Яндекс.Диск, Dropbox и т.д.)" maxlength="200" class="block w-full max-w-none bg-gray-100 rounded-xl px-4 py-4 outline-none text-base md:text-lg">
      <div class="flex items-start gap-2">
        <input type="checkbox" id="consent" name="consent" class="accent-[#ff590d] w-5 h-5 mt-1" required />
        <label for="consent" class="text-sm text-gray-700">Даю <a href="/consent" target="_blank" class="underline text-[#ff590d]">Согласие на обработку персональных данных</a> и принимаю <a href="/policy" target="_blank" class="underline text-[#ff590d]">Политику в отношении обработки персональных данных</a></label>
      </div>
      <button type="submit" class="bg-[#ff590d] hover:bg-orange-600 transition w-full py-4 rounded-2xl text-xl font-bold text-white shadow-lg flex items-center gap-2 justify-center focus:outline-none focus:ring-4 focus:ring-[#ff590d]/30 mt-2">Отправить</button>
    </form>
  </div>
</div>

<script type="text/javascript" src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
<script src="https://unpkg.com/imask"></script>
<script>
// Popup при попытке ухода со страницы
let popupShown = false;
window.addEventListener('mouseout', function(e) {
    if (!popupShown && e.relatedTarget == null) {
        document.getElementById('popup-overlay').style.display = 'flex';
        popupShown = true;
    }
});
document.getElementById('popup-close').onclick = function() {
    document.getElementById('popup-overlay').style.display = 'none';
};
// Онлайн-форма расчета
if (document.getElementById('calcForm')) {
    document.getElementById('calcForm').onsubmit = async function(e) {
        e.preventDefault();
        var name = document.getElementById('calcForm').elements['name'].value.trim();
        var phone = document.getElementById('calcForm').elements['phone'].value.trim();
        var email = document.getElementById('calcForm').elements['email'].value.trim();
        var consent = document.getElementById('consent').checked;
        var phonePattern = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
        if (!name || name.length < 2) {
            showToast('Введите корректное имя (минимум 2 буквы)', 'error');
            return false;
        }
        if (!phonePattern.test(phone)) {
            showToast('Введите телефон в формате +7 (999) 999-99-99', 'error');
            return false;
        }
        if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
            showToast('Введите корректный email', 'error');
            return false;
        }
        if (!consent) {
            showToast('Необходимо согласие на обработку данных', 'error');
            return false;
        }
        var formData = new FormData(document.getElementById('calcForm'));
        showToast('Отправка...', 'success');
        try {
            let resp = await fetch('/send-calc-form', {
                method: 'POST',
                body: formData
            });
            let data = await resp.json();
            if (data.success) {
                showToast('Заявка принята! С вами свяжется менеджер в ближайшее время.', 'success');
                document.getElementById('calcForm').reset();
            } else {
                showToast(data.message || 'Ошибка отправки', 'error');
            }
        } catch (err) {
            showToast('Ошибка отправки', 'error');
        }
    };
}
// Мини-калькулятор
if (document.getElementById('miniCalcForm')) {
    document.getElementById('miniCalcForm').onsubmit = function(e) {
        e.preventDefault();
        var tons = parseFloat(this.tons.value);
        var coeff = parseFloat(this.difficulty.value);
        var price = Math.round(tons * coeff * 2500);
        var discount = Math.round(price * 0.9);
        document.getElementById('miniCalcResult').innerHTML =
            `<div class='text-xl font-bold text-[#123392] mb-2'>{{ _('Полная стоимость') }}: <span class='text-black'>${price} ₽</span></div>` +
            `<div class='text-lg font-semibold text-green-600'>{{ _('С учётом скидки 10% для первого заказа') }}: <span class='text-black'>${discount} ₽</span></div>`;
    };
}
// Popup-скидка
if (document.getElementById('popupForm')) {
    document.getElementById('popupForm').onsubmit = async function(e) {
        e.preventDefault();
        var form = document.getElementById('popupForm');
        var formData = new FormData(form);
        showToast('{{ _('Отправка...') }}', 'success');
        try {
            let resp = await fetch('/popup-email', {
                method: 'POST',
                body: formData
            });
            let data = await resp.json();
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) form.reset();
        } catch (err) {
            showToast('Ошибка отправки', 'error');
        }
    };
}
// Яндекс.Карта с точным адресом и popup
if (document.getElementById('yandex-map')) {
    ymaps.ready(function () {
        var map = new ymaps.Map('yandex-map', {
            center: [56.843275, 60.626454],
            zoom: 16,
            controls: ['zoomControl', 'fullscreenControl']
        });
        var placemark = new ymaps.Placemark([56.843275, 60.626454], {
            balloonContent: '<b>МеталлМод</b><br>Екатеринбург, Первомайская 56<br>+7 (999) 527-42-10',
            hintContent: 'МеталлМод'
        }, {
            preset: 'islands#orangeIcon',
            iconColor: '#ff590d'
        });
        map.geoObjects.add(placemark);
        map.behaviors.disable('scrollZoom');
    });
}
// Новый fade-слайдер отзывов: fade-анимация для всей тройки, индикаторы, автосмена, без багов
(function(){
    var slider = document.getElementById('reviews-slider');
    var wrapper = document.getElementById('reviews-slider-wrapper');
    if (!slider || !wrapper) return;
    var items = Array.from(slider.children);
    function getPerPage() {
        if (window.innerWidth < 768) return 1;
        if (window.innerWidth < 1024) return 2;
        return 3;
    }
    var perPage = getPerPage();
    var current = 0;
    var dotsContainer = document.getElementById('reviews-dots');
    function renderPage(fade) {
        perPage = getPerPage();
        var totalPages = Math.ceil(items.length/perPage);
        var start = current*perPage;
        var end = start+perPage;
        // Скрываем все
        items.forEach(function(item, i){
            item.style.display = (i >= start && i < end) ? '' : 'none';
        });
        // Индикаторы
        dotsContainer.innerHTML = '';
        for (let i=0; i<totalPages; i++) {
            var dot = document.createElement('button');
            dot.className = 'w-3 h-3 rounded-full ' + (i===current ? 'bg-[#ff590d]' : 'bg-gray-300') + ' transition';
            dot.style.outline = 'none';
            dot.onclick = function(){ fadeTo(i); };
            dotsContainer.appendChild(dot);
        }
    }
    function fadeTo(page) {
        if (page === current) return;
        slider.style.opacity = '0';
        setTimeout(function(){
            current = page;
            renderPage(false);
            slider.style.opacity = '1';
        }, 500);
    }
    function showNext() {
        var totalPages = Math.ceil(items.length/perPage);
        fadeTo((current+1)%totalPages);
    }
    var interval = setInterval(showNext, 30000);
    window.addEventListener('resize', function(){
        perPage = getPerPage();
        current = 0;
        renderPage(false);
    });
    // Первый рендер
    slider.style.opacity = '1';
    renderPage(false);
})();
// Открытие/закрытие модального окна КМ
document.addEventListener('DOMContentLoaded', function() {
  var openBtn = document.getElementById('open-km-modal');
  var modal = document.getElementById('km-modal');
  var closeBtn = document.getElementById('close-km-modal');
  if (openBtn && modal && closeBtn) {
    openBtn.onclick = function() { modal.classList.remove('hidden'); };
    closeBtn.onclick = function() { modal.classList.add('hidden'); };
    modal.onclick = function(e) {
      if (e.target === modal) modal.classList.add('hidden');
    };
  }
  // Маска для телефона в kmForm
  var kmPhoneInput = document.querySelector('#kmForm input[name="phone"]');
  if (kmPhoneInput && window.IMask) {
    var mask = IMask(kmPhoneInput, {
      mask: '+{7} (000) 000-00-00',
      lazy: true
    });
    kmPhoneInput.addEventListener('focus', function() {
      if (!kmPhoneInput.value || kmPhoneInput.value === '+7') {
        mask.value = '+7 (';
        setTimeout(function() {
          kmPhoneInput.setSelectionRange(4, 4);
        }, 0);
      }
    });
  }
  // Обработка формы kmForm
  var kmForm = document.getElementById('kmForm');
  if (kmForm) {
    kmForm.onsubmit = async function(e) {
      e.preventDefault();
      var name = kmForm.querySelector('[name="name"]');
      var phone = kmForm.querySelector('[name="phone"]');
      var email = kmForm.querySelector('[name="email"]');
      var km_link = kmForm.querySelector('[name="km_link"]');
      var consent = kmForm.querySelector('[name="consent"]');
      var phonePattern = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
      if (!name.value.trim() || name.value.trim().length < 2) {
        showToast('Введите корректное имя (минимум 2 буквы)', 'error');
        return false;
      }
      if (!phonePattern.test(phone.value.trim())) {
        showToast('Введите телефон в формате +7 (999) 999-99-99', 'error');
        return false;
      }
      if (!email.value.trim() || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email.value.trim())) {
        showToast('Введите корректный email', 'error');
        return false;
      }
      if (km_link && km_link.value && km_link.value.length > 0 && !/^https?:\/\//.test(km_link.value)) {
        showToast('Ссылка должна начинаться с http:// или https://', 'error');
        return false;
      }
      if (!consent.checked) {
        showToast('Необходимо согласие на обработку данных', 'error');
        return false;
      }
      var formData = new FormData(kmForm);
      showToast('Отправка...', 'success');
      try {
        let resp = await fetch('/send-km-form', {
          method: 'POST',
          body: formData
        });
        let data = await resp.json();
        if (data.success) {
          showToast('Заявка принята! С вами свяжется менеджер в ближайшее время.', 'success');
          kmForm.reset();
          setTimeout(function() {
            var modal = document.getElementById('km-modal');
            if (modal) modal.classList.add('hidden');
          }, 2500);
        } else {
          showToast(data.message || 'Ошибка отправки', 'error');
        }
      } catch (err) {
        showToast('Ошибка отправки', 'error');
      }
    };
  }
  // Маска для телефона (IMask.js)
  document.querySelectorAll('input[type="tel"]').forEach(function(input) {
    IMask(input, { mask: '+{7} (000) 000-00-00' });
  });
  // Открытие модального окна КМ по всем кнопкам с классом open-km-modal
  const kmModal = document.getElementById('km-modal');
  const openKmBtns = document.querySelectorAll('.open-km-modal');
  const closeKmBtn = document.getElementById('close-km-modal');
  openKmBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      kmModal.classList.remove('hidden');
    });
  });
  closeKmBtn.addEventListener('click', function() {
    kmModal.classList.add('hidden');
  });
  kmModal.onclick = e => { if (e.target === kmModal) kmModal.classList.add('hidden'); };
});
</script>
<style>
.swiper,
.swiper-wrapper,
.swiper-slide {
  overflow: visible !important;
}
html, body {
  overflow-x: hidden;
}
@keyframes modal-fade-in {
  from { opacity: 0; transform: scale(0.95); }
  to   { opacity: 1; transform: scale(1); }
}
.portfolio-modal-animate-in {
  animation: modal-fade-in 0.35s cubic-bezier(.4,2,.6,1) both;
}
@keyframes fade-out {
  from { opacity: 1; transform: scale(1); }
  to   { opacity: 0; transform: scale(0.95); }
}
.animate-fade-out {
  animation: fade-out 0.3s cubic-bezier(.4,2,.6,1) both;
}
</style>
{% endblock %} 